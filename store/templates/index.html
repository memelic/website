{% extends 'base.html' %}

{% load custom_filters %}


{% block content %}

<!-- Displaying JSON data -->
<section class="py-0">
  <div class="container-fluid">
    <div class="container mt-5 text-light">

      <div class="row">
        <div class="col-md-12">
          <h1 class="text-center mt-5 mb-4">Welcome to flushCat.com</h1>
          <h3 class="text-center mb-4">alpha v{{pokerGPT_version}}</h3>     
        </div>  
      </div>            
      <div class="row">
        <div class="col-md-12">
          <p class="intro-text">Where the thrill of poker meets the power of chatGPT! Challenge chatGPT in exhilarating poker games, sharpen your strategies, and refine your skills in a dynamic environment. Whether you're a seasoned player or just starting out, this game offers a unique opportunity to test your skills against chatGPT.</p>
          <p><div id="walletAddress"></div>  </p>
          <p>To join the game, you need one million Pump Fun Club tokens. For now, you can view all games for free. This is just the beginning; there's much more to come. Stay tuned for exciting updates!</p>
          <p>Solana Contract Address: <a href="https://www.pump.fun/{{tokenMintAddress}}" >{{tokenMintAddress}}</a></p>           
          {%if access_token %}
            <p id="tokenBalance" >flushCat Token balance: {{access_token.token_balance}}</p> 
            <p><a href="/game_create/" id="startButton" class="btn btn-primary" >Start Game</a> </p> 
          {% else %}             
            <p id="tokenBalance" style="display: none;">flushCat Token balance: </p> 
            <p><button id="connectButton">Connect to Phantom</button> </p> 
            <p><a href="/game_create/" id="startButton" style="display: none;" class="btn btn-primary">Start Game</a> </p> 
          {% endif %}          
        </div>  
      </div>  
      <div class="row">
        <div class="col-md-12">
          <h2 class="mt-5 mb-3">Features:</h2>
          <ul class="list-unstyled">
            <li class="mt-5 mb-3"><strong>Play Against chatGPT:</strong> Experience the excitement of poker with chatGPT as your opponent. Every game is a chance to learn, adapt, and conquer!</li>
            <li class="mt-5 mb-3"><strong>Skill Training:</strong> Hone your poker skills with interactive tutorials and practice sessions. From beginner basics to advanced techniques, elevate your game at your own pace.</li>
            <li class="mt-5 mb-3"><strong>Create Your Profile:</strong> Join our community by creating a personalized profile. Track your progress, showcase your achievements, and connect with fellow poker enthusiasts.</li>
            <li class="mt-5 mb-3"><strong>Leaderboards:</strong> Compete for the top spot on our leaderboard. Earn recognition for your prowess and see how you stack up against other players.</li>
            <li class="mt-5 mb-3"><strong>Networking Opportunities:</strong> Engage with like-minded individuals, discuss strategies, and build connections within our vibrant community.</li>
            <li class="mt-5 mb-3"><strong>Real-Life Meetups:</strong> Take your online connections offline with occasional meetups and events. Connect face-to-face with fellow players and share your passion for poker.</li>
          </ul>
          <p><a href="{% url 'all_games' %}" class="btn btn-primary">All Games</a></p>
          <p>Explore All Games Played on Our Platform</p>

          <p>Discover a unique poker experience where every game is an opportunity to sharpen your skills against Flush Cat. Each match features analytics that provide real-time insights into the gameplay. Challenge yourself by choosing the number of opponents and engage in strategic battles of human intuition against cat. Click here to delve into a world where every hand is a chance to elevate your poker prowess.</p>
          <p class="mt-5 text-center"><em>Join flushCat.com today and embark on a journey where skill meets cat, and every hand is a chance to win big!</em></p>
        </div>
      </div>
    </div>
  </div>
</section>  
<script>
  // Function to convert ArrayBuffer to Base64
  function arrayBufferToBase64(buffer) {
    let binary = '';
    const bytes = new Uint8Array(buffer);
    const len = bytes.byteLength;
    console.log('test');
    console.log(len);
    for (let i = 0; i < len; i++) {
        binary += String.fromCharCode(bytes[i]);
        console.log(binary);
    }
    return window.btoa(binary);
  }

  document.getElementById('connectButton').addEventListener('click', async () => {
    if (window.solana && window.solana.isPhantom) {
      try {
        // Connect to Phantom wallet
        const response = await window.solana.connect();
        console.log('Connected to Phantom wallet');

        // Update the page with the connected wallet address
        document.getElementById('walletAddress').textContent = `Connected wallet: ${response.publicKey.toString()}`;

        // Sign a message and print it to the console
        const message = new TextEncoder().encode('Hello from ChatGPTdotfun!');
        const signedMessage = await window.solana.signMessage(message);
        console.log('Message signed:', signedMessage);

        // Convert the signature bytes to Base64 

        const signature = signedMessage.signature;

        // Convert the signature data to Base64
        const signatureBase64 = arrayBufferToBase64(signature);
 

        console.log('Message signed (Base64):', signatureBase64);
        const verifySignatureUrl = `/verify_signature/?publicKey=${response.publicKey.toString()}&signature=${encodeURIComponent(signatureBase64)}`;

        // Example function to send GET request to Django view
        async function verifySignature() {
            try {
                const response = await fetch(verifySignatureUrl);
                if (!response.ok) {
                    throw new Error('Failed to verify signature.');
                }
                const result = await response.json();
                console.log('Verification Result:', result);

                // Assuming result.valid is a boolean indicating verification status
                if (result.valid) {
                    // Change text color to green
                    document.getElementById('tokenBalance').style.color = 'green';
                    document.getElementById('connectButton').style.display = 'none';
                    //document.getElementById('startButton').style.display = 'inline';
                    document.getElementById('tokenBalance').style.display = 'inline';
                } else {
                    // Optionally handle non-verified state
                    document.getElementById('tokenBalance').style.color = 'black'; // Or default color
                }

            } catch (error) {
                console.error('Verification Error:', error.message);
            }
        }

        verifySignature();


        // Fetch the balance of a specific SPL token
        const tokenMintAddress = '{{tokenMintAddress}}'; // Replace with the actual SPL token mint address
        const rpcUrl = 'https://solana-mainnet.g.alchemy.com/v2/brUu7bUWYqnL02KEqM_k1GWoLgTtkGvg'; // Replace with your QuickNode URL
        console.log('RPC URL:', rpcUrl);
        const connection = new solanaWeb3.Connection(rpcUrl);

        const tokenAccounts = await connection.getParsedTokenAccountsByOwner(response.publicKey, {
          mint: new solanaWeb3.PublicKey(tokenMintAddress)
        });

        let tokenBalance = 0;
        if (tokenAccounts.value.length > 0) {
          tokenAccounts.value.forEach(accountInfo => {
            tokenBalance += accountInfo.account.data.parsed.info.tokenAmount.uiAmount;
            if (tokenBalance >= 100000000) {
                document.getElementById('startButton').style.display = 'inline';
            } else {
                document.getElementById('startButton').style.display = 'none';
            }

          });
        }

        console.log(`Token balance: ${tokenBalance}`);
        document.getElementById('tokenBalance').textContent = `Token balance: ${tokenBalance}`;

      } catch (error) {
        console.error('Error connecting to Phantom wallet:', error);

        // Detailed error logging
        if (error.response && error.response.status === 403) {
          console.error('403 Forbidden error: You may have been rate-limited or have incorrect headers.');
        } else {
          console.error('Other error:', error.message);
        }
      }
    } else {
      alert('Phantom wallet not found');
    }
  });
</script>
{% endblock %}
